### 02.k8s踩坑记录

##### 踩坑1.Kubernetes主机间curl cluster ip时不通

- 问题现象

  - 测试部署了一个service，包括2个pod，分别在node1和node2上。

    ```
    [root@k8s-master01 06]# kubectl get svc -o wide
    NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE   SELECTOR
    kubernetes   ClusterIP   10.96.0.1      <none>        443/TCP   8d    <none>
    nginx-svc    ClusterIP   10.104.60.94   <none>        80/TCP    15m   name=nginx
    ```

    

  - 在node1（或者node2）上curl 10.254.132.190（cluster ip），只有当负载到本地pod时正常，curl <本地pod ip和另一个主机pod ip>是正常的。

    ```
    [root@k8s-master01 06]# kubectl get pod -o wide
    NAME                        READY   STATUS    RESTARTS   AGE   IP            NODE         NOMINATED NODE   READINESS GATES
    nginx-dm-5496d4bc4d-5ncg6   1/1     Running   0          16m   10.244.2.15   k8s-node01   <none>           <none>
    nginx-dm-5496d4bc4d-w85z7   1/1     Running   0          16m   10.244.1.15   k8s-node02   <none>           <none>
    ```

  - ip route 

    ```
    [root@k8s-master01 06]# ip route 
    default via 10.0.2.2 dev eth0 proto dhcp metric 100 
    10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100 
    10.244.1.0/24 via 10.244.1.0 dev flannel.1 onlink 
    10.244.2.0/24 via 10.244.2.0 dev flannel.1 onlink 
    172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 linkdown 
    192.168.33.0/24 dev eth1 proto kernel scope link src 192.168.33.10 metric 101 
    ```

- 解决方案

  - 添加如下路由解决

    ```
    ip route add 10.104.0.0/16 dev flannel.1
    ```

    ```
    ip route add 10.104.0.0/16 dev docker0
    ```

    